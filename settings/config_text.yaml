# =====================================================================
# settings/config_text.yaml (single source of truth, paper-strict)
# - NO python tuple tags
# - ngram_range kept as list [a,b], code converts to tuple
# =====================================================================

common:
  seed: &seed 42

  split_test_size: &split_test_size 0.2
  length_std_k: &length_std_k 2.5
  min_per_class: &min_per_class 2

  logreg_C: &logreg_C 1.0
  logreg_max_iter: &logreg_max_iter 1000
  max_seq_length: &max_seq_length 512

asr:
  # choose ONE:
  data_root: "/content/NCMMSC2021_AD_Competition-dev/dataset/merge_vad"
  # data_root: "/content/NCMMSC2021_AD_Competition-dev/dataset/raw"
  # data_root: "/content/NCMMSC2021_AD_Competition-dev/dataset/raw_vad"
  # data_root: "/content/NCMMSC2021_AD_Competition-dev/dataset/merge"
  
  # output_csv: "/content/ncmmsc_merged_asr_transcripts.csv"
  output_csv: "/content/NCMMSC2021_AD_Competition-dev/ncmmsc_merged_asr_transcripts.csv"
  model_size: "large-v3"
  device: "cuda"
  compute_type: "float16"

  initial_prompt: |-
    請以繁體中文逐字轉寫（不要翻譯/潤飾/摘要）。
    保留語助詞與猶豫聲、重複、自我修正與中斷。
    聽不清楚以【聽不清楚】標示；AD/HC/MCI 保留大寫。
    常見詞：失智症、阿茲海默症、認知功能、記憶力、量表、測驗、醫師、受試者、照顧者。

  decode:
    language: "zh"
    task: "transcribe"
    beam_size: 10
    patience: 1.0
    length_penalty: 1.0
    temperature: 0.0
    compression_ratio_threshold: 2.4
    log_prob_threshold: -1.0
    no_speech_threshold: 0.6
    condition_on_previous_text: false
    vad_filter: false
    without_timestamps: true

predictive:
  meta_csv: "/content/NCMMSC2021_AD_Competition-dev/2_final_list_train.csv"
  egemaps_csv: "/content/NCMMSC2021_AD_Competition-dev/egemaps_final.csv"
  tsv_root: "/content/NCMMSC2021_AD_Competition-dev/tsv2"
  output_text_jsonl: &predictive_jsonl "/content/Chinese-predictive_challenge_tsv2_output.jsonl"
  output_egemaps_csv: "/content/predictive_egemaps_features.csv"
  dataset_name: "Chinese_predictive_challenge"

  keep_speakers: &pred_keep_speakers ["<B>"]
  tsv:
    keep_speakers: *pred_keep_speakers
    drop_silence: true
    order_by: "no"

text:
  output_dir: "/content/chinese_combined"
  combined_name: "Chinese_Combined.jsonl"
  cleaned_jsonl: "/content/chinese_combined/cleaned.jsonl"

  ncmmsc_jsonl: &ncmmsc_jsonl "/content/chinese_combined/ncmmsc_from_asr.jsonl"

  corpora:
    - name: "NCMMSC2021_AD_Competition"
      path: *ncmmsc_jsonl
    - name: "Chinese_predictive_challenge"
      path: *predictive_jsonl
    - name: "TAUKADIAL"
      path: null

  target_datasets:
    - "NCMMSC2021_AD_Competition"
    - "Chinese_predictive_challenge"

  target_labels: ["AD", "HC"]

  balance: false
  subset_seed: *seed
  cap_per_class: 300

  post_length_subset: false

  label_map:
    NC: "HC"
    CN: "HC"
    CTRL: "HC"
    CONTROL: "HC"
    CONTROLS: "HC"
    HEALTHY: "HC"
    NORMAL: "HC"
    "Control": "HC"
    "Controls": "HC"
    "Healthy": "HC"
    "Normal": "HC"
    "HEALTHYCONTROL": "HC"
    "HEALTHY_CONTROL": "HC"
    "HEALTHY CONTROL": "HC"

    PROBABLEAD: "AD"
    POSSIBLEAD: "AD"
    "ProbableAD": "AD"
    "PossibleAD": "AD"
    "PROBABLE_AD": "AD"
    "POSSIBLE_AD": "AD"
    "PROBABLE AD": "AD"
    "POSSIBLE AD": "AD"

    MILDCOGNITIVEIMPAIRMENT: "MCI"
    "MildCognitiveImpairment": "MCI"
    "MILD_COGNITIVE_IMPAIRMENT": "MCI"
    "MILD COGNITIVE IMPAIRMENT": "MCI"
    MCI: "MCI"

  language_filter:
    drop_languages: ["en"]

  prompt_filter:
    enabled: true
    apply_datasets: ["NCMMSC2021_AD_Competition"]

    mode: "leading"
    max_leading_sentences: 12
    min_keep_chars: 20

    patterns:
      - "^[\\s　]*(好|那|那我們|那我们|現在|现在|接下來|接下来|接著|接着|等一下|請|麻煩|麻烦)[，,、\\s　]{0,2}.{0,12}(你|您)[\\s　]{0,2}.{0,10}(描述|說|说|講|讲|告訴我|告诉我|講講|讲讲|說說|说说)"
      - "^[\\s　]*(請|麻煩|麻烦)[，,、\\s　]{0,2}.{0,12}(把|再把|盡量|尽量)[\\s　]{0,2}.{0,12}(你|您)?[\\s　]{0,2}.{0,10}(看到|看見|看见)[\\s　]{0,2}.{0,12}(告訴我|告诉我|說|说|講|讲|描述)"
      - "^[\\s　]*(我們|咱們|咱们)[，,、\\s　]{0,2}.{0,12}(來看|来看|看一下|看一看|看下)[\\s　]{0,2}.{0,12}(這張|这张|這個|这个).{0,6}(圖|图|圖片|图片|畫|画)"
      - "^[\\s　]*(你|您)[，,、\\s　]{0,2}.{0,10}(看到|看見|看见)[\\s　]{0,2}.{0,12}(什麼|什么)[?？]?$"
      - "^[\\s　]*(他們|他们)[，,、\\s　]{0,2}.{0,12}(在做什麼|在做什么)[?？]?$"
      - "^[\\s　]*(越多越好|說得越多越好|说得越多越好|講得越多越好|讲得越多越好)[。！？!?]?$"
      - "^[\\s　]*(然後呢|然后呢|還有呢|还有呢)[?？]?$"

    echo_enabled: true
    echo_patterns:
      # ===== echo_patterns =====
      - "(請以繁體中文逐字轉寫|请以繁体中文逐字转写|完整逐字轉寫|完整逐字转写)"
      - "(不要翻譯|不要翻译|不要潤飾|不要润饰|不要做任何摘要|不要做摘要)"
      - "(保留語助詞|保留语助词|猶豫聲|犹豫声|重複|重复|自我修正|中斷|中断)"
      - "(聽不清楚以【聽不清楚】標示|听不清楚以【聽不清楚】标示|若有單字實在聽不清楚|请不要乱猜|請不要亂猜)"
      - "(AD/HC/MCI\\s*保留大寫|AD\\s*/\\s*HC\\s*/\\s*MCI\\s*保留大寫|保留大写)"
      - "(常見詞：|常见词：|失智症|阿茲海默症|阿尔茨海默|認知功能|记忆力|量表|測驗|受試者|照顧者)"

      # ===== 把 initial_prompt 每一行都單獨抓 =====
      - "(請以繁體中文逐字轉寫（不要翻譯/潤飾/摘要）|请以繁体中文逐字转写（不要翻译/润饰/摘要）)"
      - "(保留語助詞與猶豫聲、重複、自我修正與中斷|保留语助词与犹豫声、重复、自我修正与中断)"
      - "(聽不清楚以【聽不清楚】標示；AD/HC/MCI\\s*保留大寫|听不清楚以【聽不清楚】标示；AD/HC/MCI\\s*保留大写)"
      - "(常見詞：失智症、阿茲海默症、認知功能、記憶力、量表、測驗、醫師、受試者、照顧者|常见词：失智症、阿尔茨海默症、认知功能、记忆力、量表、测验、医师、受试者、照顾者)"

      # ===== 訪談者短句/追問 =====
      - "^[\\s　]*(這|这)(個|句|段).{0,10}(也)?(要)?(說|说|講|讲)(嗎|吗)[?？]?$"
      - "^[\\s　]*(再|再說|再说).{0,10}(一次|一遍|一下)[?？]?$"
      - "^[\\s　]*(你|您)?[\\s　]*(還有|还有|然後|然后)(呢)?[?？]?$"
      - "^[\\s　]*(嗯|呃|啊)?[\\s　]*(這個|这个|那個|那个)(呢)?[?？]?$"

  quality_filter:
    enabled: true
    min_chars: 15
    min_lex_chars: 8
    min_han: 6
    max_unk_ratio: 0.75

  length_filter:
    enabled: true
    std_k: *length_std_k
    min_class_n: 30

features:
  tfidf:
    vectorizer:
      analyzer: "char"
      ngram_range: [2, 4]
      lowercase: false
      max_features: 50000
      stop_words: null
      min_df: 1
      max_df: 1.0
    transformer:
      use_idf: true
      smooth_idf: true
      norm: "l2"
      sublinear_tf: false
    logreg:
      C: *logreg_C
      class_weight: "balanced"
      solver: "lbfgs"
      max_iter: *logreg_max_iter
      random_state: *seed

  bert:
    model_name: "/content/models/bert-base-chinese"
    pooling: "mean"
    max_seq_length: *max_seq_length
    device: "cuda"
    logreg:
      C: *logreg_C
      class_weight: "balanced"
      solver: "lbfgs"
      max_iter: *logreg_max_iter
      random_state: *seed

  glove:
    embeddings_path: "/content/embeddings/cc.zh.300.vec"
    embedding_dim: 300
    tokenizer: "jieba"
    max_words: 50000
    lowercase: false
    remove_stopwords: false
    stopwords_lang: null
    pooling: "sum_l2norm"
    logreg:
      C: *logreg_C
      class_weight: "balanced"
      solver: "lbfgs"
      max_iter: *logreg_max_iter
      random_state: *seed

  gemma:
    model_name: "/content/models/google__gemma-2b"
    pooling: "mean"
    max_seq_length: *max_seq_length
    device: "cuda"
    logreg:
      C: *logreg_C
      class_weight: "balanced"
      solver: "lbfgs"
      max_iter: *logreg_max_iter
      random_state: *seed

  crossval:
    enabled: true

    # 每個 fold 的 TRAIN 做平衡
    train_balance:
      enabled: true
      strategy: "downsample"   # "downsample" | "upsample" | "none"
      random_state: *seed

    n_splits: 5
    shuffle: true
    random_state: *seed
    output_indices: "/content/chinese_combined/folds_indices.json"

    methods: ["tfidf", "bert", "glove", "gemma"]
    tfidf_fit_scope: "train"   # "full" | "train"

    batch_size: 8
    bert_batch_size: 8
    gemma_batch_size: 4

    metrics_average: "macro"
    zero_division: 0
    metrics_output: "/content/chinese_combined/cv_metrics.json"

    print_classification_report: true
    print_confusion_matrix: true
    print_method_summary: true
